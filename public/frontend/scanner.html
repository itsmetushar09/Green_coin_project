<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Device Scanner - Green Coins</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .upload-area {
            border: 2px dashed #10B981;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
        }
        .upload-area:hover {
            border-color: #059669;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.1);
        }
        .upload-area.dragover {
            border-color: #059669;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            transform: scale(1.02);
        }
        .device-btn {
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
        }
        .device-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
        }
        .device-btn.selected {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }
        .scanner-animation {
            animation: pulse 2s infinite;
        }
        .processing-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }
        .progress-bar {
            background: linear-gradient(90deg, #10b981, #34d399, #10b981);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .bg-green-gradient {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .nav-gradient {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        }
        .hero-gradient {
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 50%, #e6fffa 100%);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="nav-gradient shadow-lg sticky top-0 z-50 border-b border-green-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="index.html" class="flex items-center space-x-3 hover:opacity-80 transition-opacity">
                        <div class="bg-green-gradient p-2 rounded-xl shadow-md">
                            <i class="fas fa-recycle text-white text-xl"></i>
                        </div>
                        <div>
                            <span class="text-xl font-bold text-gray-800">Green Coins</span>
                            <div class="text-xs text-green-600 font-medium">AI Scanner</div>
                        </div>
                    </a>
                </div>
                
                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center space-x-6">
                    <a href="index.html" class="text-gray-600 hover:text-green-600 transition-colors">Home</a>
                    <a href="scanner.html" class="text-green-600 font-semibold border-b-2 border-green-600 pb-1">Scanner</a>
                    <a href="rewards.html" class="text-gray-600 hover:text-green-600 transition-colors">Rewards</a>
                    <a href="kiosks.html" class="text-gray-600 hover:text-green-600 transition-colors">Kiosks</a>
                    <a href="community.html" class="text-gray-600 hover:text-green-600 transition-colors">Community</a>
                    <a href="leaderboard.html" class="text-gray-600 hover:text-green-600 transition-colors">Leaderboard</a>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2 bg-green-100 px-4 py-2 rounded-full">
                        <i class="fas fa-coins text-green-600"></i>
                        <span id="nav-coins" class="font-bold text-green-600">Loading...</span>
                    </div>
                    <button id="menu-toggle" class="md:hidden p-2">
                        <i class="fas fa-bars text-gray-600"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="hero-gradient py-12">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <div class="fade-in-up">
                <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-robot text-green-500 mr-3"></i>
                    AI Device Scanner
                </h1>
                <p class="text-lg md:text-xl text-gray-600 max-w-3xl mx-auto mb-8">
                    Upload a photo of your electronic device and our AI will identify it, 
                    calculate its value, and reward you with Green Coins instantly!
                </p>
                <div class="flex flex-wrap justify-center gap-4 text-sm text-green-700">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-check-circle"></i>
                        <span>Instant AI Recognition</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-coins"></i>
                        <span>Earn Green Coins</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-leaf"></i>
                        <span>Help Environment</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Device Type Selection -->
        <div class="mb-8 fade-in-up">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">What are you recycling today?</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <button class="device-btn p-6 rounded-2xl shadow-md hover:shadow-xl border border-gray-200" data-device="smartphone">
                    <div class="text-4xl mb-3">üì±</div>
                    <div class="font-bold text-gray-800 mb-1">Phone</div>
                    <div class="text-sm text-green-600 font-semibold">60-80 coins</div>
                </button>
                <button class="device-btn p-6 rounded-2xl shadow-md hover:shadow-xl border border-gray-200" data-device="laptop">
                    <div class="text-4xl mb-3">üíª</div>
                    <div class="font-bold text-gray-800 mb-1">Laptop</div>
                    <div class="text-sm text-green-600 font-semibold">120-150 coins</div>
                </button>
                <button class="device-btn p-6 rounded-2xl shadow-md hover:shadow-xl border border-gray-200" data-device="tablet">
                    <div class="text-4xl mb-3">üì±</div>
                    <div class="font-bold text-gray-800 mb-1">Tablet</div>
                    <div class="text-sm text-green-600 font-semibold">80-120 coins</div>
                </button>
                <button class="device-btn p-6 rounded-2xl shadow-md hover:shadow-xl border border-gray-200" data-device="charger">
                    <div class="text-4xl mb-3">üîå</div>
                    <div class="font-bold text-gray-800 mb-1">Charger</div>
                    <div class="text-sm text-green-600 font-semibold">12-15 coins</div>
                </button>
            </div>
        </div>

        <!-- Upload Area -->
        <div class="mb-8 fade-in-up">
            <div id="upload-area" class="upload-area rounded-3xl p-12 text-center cursor-pointer border-2 shadow-lg">
                <div class="scanner-animation mb-6">
                    <i class="fas fa-camera text-6xl text-green-500"></i>
                </div>
                <h3 class="text-3xl font-bold text-gray-800 mb-4">Upload Device Image</h3>
                <p class="text-gray-600 mb-6 text-lg">Drag & drop or click to select your device photo</p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                    <button id="camera-btn" class="bg-green-gradient text-white px-8 py-4 rounded-xl hover:shadow-lg flex items-center space-x-3 transition-all font-semibold text-lg">
                        <i class="fas fa-camera text-xl"></i>
                        <span>Take Photo</span>
                    </button>
                    <button id="gallery-btn" class="border-2 border-green-500 text-green-600 px-8 py-4 rounded-xl hover:bg-green-gradient hover:text-white flex items-center space-x-3 transition-all font-semibold text-lg">
                        <i class="fas fa-image text-xl"></i>
                        <span>Choose from Gallery</span>
                    </button>
                </div>
                <div class="mt-6 flex justify-center space-x-6 text-sm text-gray-500">
                    <div class="flex items-center space-x-1">
                        <i class="fas fa-check text-green-500"></i>
                        <span>JPG, PNG supported</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <i class="fas fa-check text-green-500"></i>
                        <span>Max 10MB</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <i class="fas fa-shield-alt text-green-500"></i>
                        <span>Secure & Private</span>
                    </div>
                </div>
            </div>
            <input type="file" id="device-image-input" accept="image/*" style="display: none;">
        </div>

        <!-- Error Messages -->
        <div id="error-message" class="hidden bg-red-50 border-l-4 border-red-400 text-red-700 px-6 py-4 rounded-lg mb-6 shadow-md">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle mr-3"></i>
                <span id="error-text"></span>
            </div>
        </div>

        <!-- Authentication Notice -->
        <div id="auth-notice" class="hidden bg-yellow-50 border-l-4 border-yellow-400 text-yellow-700 px-6 py-4 rounded-lg mb-6 shadow-md">
            <div class="flex items-center">
                <i class="fas fa-sign-in-alt mr-3"></i>
                <span>Please <a href="index.html" class="underline font-semibold hover:text-yellow-800">sign in</a> to use the device scanner</span>
            </div>
        </div>

        <!-- Preview Area -->
        <div id="image-preview" class="hidden mb-8"></div>

        <!-- Results Area -->
        <div id="scan-results" class="hidden mb-8"></div>

        <!-- Recent Scans -->
        <div class="bg-white rounded-3xl p-8 shadow-lg fade-in-up border border-gray-100">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-history text-gray-500 mr-3"></i>
                Recent Scans
            </h3>
            <div id="recent-scans" class="space-y-3">
                <div class="text-center py-12">
                    <i class="fas fa-camera text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500 text-lg">No recent scans yet</p>
                    <p class="text-gray-400">Upload your first device to get started!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scanner JavaScript -->
    <script>
        class IntegratedDeviceScanner {
            constructor() {
                this.API_BASE_URL = 'http://localhost:5000/api';
                this.token = localStorage.getItem('greenCoinsToken');
                this.currentScan = null;
                this.selectedDeviceType = null;
                this.init();
            }

            init() {
                console.log('üöÄ Integrated Scanner initialized');
                this.bindEvents();
                this.checkAuth();
                this.loadUserStats();
            }

            checkAuth() {
                if (!this.token) {
                    console.log('‚ö†Ô∏è No token found, showing auth notice');
                    this.showAuthNotice();
                    return false;
                }
                console.log('‚úÖ User authenticated');
                this.hideAuthNotice();
                return true;
            }

            showAuthNotice() {
                const authNotice = document.getElementById('auth-notice');
                const uploadArea = document.getElementById('upload-area');
                
                if (authNotice) {
                    authNotice.classList.remove('hidden');
                }
                
                if (uploadArea) {
                    uploadArea.style.opacity = '0.6';
                    uploadArea.style.pointerEvents = 'none';
                }
            }

            hideAuthNotice() {
                const authNotice = document.getElementById('auth-notice');
                const uploadArea = document.getElementById('upload-area');
                
                if (authNotice) {
                    authNotice.classList.add('hidden');
                }
                
                if (uploadArea) {
                    uploadArea.style.opacity = '1';
                    uploadArea.style.pointerEvents = 'auto';
                }
            }

            async loadUserStats() {
                if (!this.token) {
                    const navCoins = document.getElementById('nav-coins');
                    if (navCoins) navCoins.textContent = '0';
                    return;
                }

                try {
                    const response = await fetch(`${this.API_BASE_URL}/users/dashboard`, {
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.updateNavCoins(data.user.coins);
                    } else {
                        console.log('‚ö†Ô∏è Failed to load user stats');
                        this.updateNavCoins(0);
                    }
                } catch (error) {
                    console.error('‚ùå Failed to load user stats:', error);
                    this.updateNavCoins(0);
                }
            }

            updateNavCoins(coins) {
                const navCoins = document.getElementById('nav-coins');
                if (navCoins) {
                    navCoins.textContent = (coins || 0).toLocaleString();
                }
            }

            bindEvents() {
                // Device type selection
                const deviceBtns = document.querySelectorAll('.device-btn');
                deviceBtns.forEach(btn => {
                    btn.addEventListener('click', () => this.selectDeviceType(btn));
                });

                // File input
                const fileInput = document.getElementById('device-image-input');
                if (fileInput) {
                    fileInput.addEventListener('change', (e) => this.handleFileUpload(e));
                }

                // Upload area
                const uploadArea = document.getElementById('upload-area');
                if (uploadArea) {
                    uploadArea.addEventListener('click', () => {
                        if (this.checkAuth() && fileInput) fileInput.click();
                    });

                    // Drag and drop
                    uploadArea.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        if (this.checkAuth()) {
                            uploadArea.classList.add('dragover');
                        }
                    });

                    uploadArea.addEventListener('dragleave', () => {
                        uploadArea.classList.remove('dragover');
                    });

                    uploadArea.addEventListener('drop', (e) => {
                        e.preventDefault();
                        uploadArea.classList.remove('dragover');
                        if (this.checkAuth() && e.dataTransfer.files.length > 0) {
                            this.handleFileSelect(e.dataTransfer.files[0]);
                        }
                    });
                }

                // Camera and gallery buttons
                const cameraBtn = document.getElementById('camera-btn');
                const galleryBtn = document.getElementById('gallery-btn');

                if (cameraBtn) {
                    cameraBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (this.checkAuth() && fileInput) {
                            fileInput.setAttribute('capture', 'environment');
                            fileInput.click();
                        }
                    });
                }

                if (galleryBtn) {
                    galleryBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (this.checkAuth() && fileInput) {
                            fileInput.removeAttribute('capture');
                            fileInput.click();
                        }
                    });
                }
            }

            selectDeviceType(btn) {
                // Remove selection from all buttons
                document.querySelectorAll('.device-btn').forEach(b => {
                    b.classList.remove('selected');
                });
                
                // Add selection to clicked button
                btn.classList.add('selected');
                this.selectedDeviceType = btn.dataset.device;
                
                console.log('üì± Selected device type:', this.selectedDeviceType);
            }

            handleFileUpload(event) {
                const file = event.target.files[0];
                console.log('üìÅ File selected:', file?.name);
                
                if (file) {
                    this.handleFileSelect(file);
                }
            }

            handleFileSelect(file) {
                console.log('üîç Processing file:', file.name, `${(file.size/1024/1024).toFixed(1)}MB`, file.type);
                
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    this.showError('Please select an image file (JPG, PNG).');
                    return;
                }

                // Validate file size (10MB limit)
                if (file.size > 10 * 1024 * 1024) {
                    this.showError('Image size should be less than 10MB.');
                    return;
                }

                // Store file and display preview
                this.selectedFile = file;
                this.displayImagePreview(file);
                this.hideError();
            }

            displayImagePreview(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const previewContainer = document.getElementById('image-preview');
                    
                    previewContainer.innerHTML = `
                        <div class="bg-white rounded-3xl p-8 shadow-lg border border-gray-100 fade-in-up">
                            <div class="relative">
                                <img src="${e.target.result}" alt="Device preview" class="w-full h-80 object-cover rounded-2xl mb-6 shadow-md">
                                <button onclick="window.deviceScanner.clearPreview()" class="absolute top-4 right-4 bg-red-500 text-white rounded-full w-10 h-10 flex items-center justify-center hover:bg-red-600 shadow-lg transition-all">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="text-center">
                                <div class="mb-4">
                                    <h4 class="text-xl font-bold text-gray-800 mb-2">Ready to Scan</h4>
                                    <p class="text-gray-600">${file.name}</p>
                                    <p class="text-sm text-gray-500">${(file.size/1024/1024).toFixed(1)}MB</p>
                                </div>
                                <button id="scan-device" class="bg-green-gradient text-white px-10 py-4 rounded-xl hover:shadow-lg flex items-center space-x-3 mx-auto font-bold text-lg transition-all">
                                    <i class="fas fa-search"></i>
                                    <span>Scan Device with AI</span>
                                </button>
                            </div>
                        </div>
                    `;
                    previewContainer.classList.remove('hidden');
                    
                    // Bind scan button
                    const scanBtn = document.getElementById('scan-device');
                    if (scanBtn) {
                        scanBtn.addEventListener('click', () => this.scanDevice());
                    }
                    
                    console.log('‚úÖ Image preview displayed');
                };
                reader.readAsDataURL(file);
            }

            clearPreview() {
                const previewContainer = document.getElementById('image-preview');
                const resultsContainer = document.getElementById('scan-results');
                
                if (previewContainer) {
                    previewContainer.classList.add('hidden');
                    previewContainer.innerHTML = '';
                }

                if (resultsContainer) {
                    resultsContainer.classList.add('hidden');
                    resultsContainer.innerHTML = '';
                }

                this.selectedFile = null;
                
                const fileInput = document.getElementById('device-image-input');
                if (fileInput) {
                    fileInput.value = '';
                }
                
                this.hideError();
                console.log('üßπ Preview cleared');
            }

            async scanDevice() {
                console.log('üîç Starting device scan...');
                
                if (!this.checkAuth()) {
                    this.showError('Please sign in to use the scanner.');
                    return;
                }
                
                if (!this.selectedFile) {
                    this.showError('Please select an image first.');
                    return;
                }

                const scanBtn = document.getElementById('scan-device');
                const originalHTML = scanBtn ? scanBtn.innerHTML : '';
                
                try {
                    // Update UI to show scanning
                    if (scanBtn) {
                        scanBtn.disabled = true;
                        scanBtn.innerHTML = '<i class="fas fa-spinner processing-spinner mr-3"></i>AI Analyzing...';
                    }

                    this.showScanningProgress();

                    // Create form data
                    const formData = new FormData();
                    formData.append('deviceImage', this.selectedFile);

                    console.log('üì° Sending request to:', `${this.API_BASE_URL}/devices/scan`);

                    // Send to API with longer timeout
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout

                    const response = await fetch(`${this.API_BASE_URL}/devices/scan`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.token}`
                        },
                        body: formData,
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    console.log('üìä Response status:', response.status);
                    const data = await response.json();
                    console.log('üìã Response data:', data);

                    if (response.ok) {
                        this.currentScan = data;
                        this.displayScanResults(data);
                    } else {
                        this.showError(data.message || 'Failed to scan device. Please try again.');
                    }

                } catch (error) {
                    console.error('‚ùå Scan error:', error);
                    if (error.name === 'AbortError') {
                        this.showError('Scan timed out. Please try again with a smaller image.');
                    } else {
                        this.showError('Failed to scan device. Please check your connection and try again.');
                    }
                } finally {
                    if (scanBtn) {
                        scanBtn.disabled = false;
                        scanBtn.innerHTML = originalHTML;
                    }
                }
            }

            showScanningProgress() {
                const resultsContainer = document.getElementById('scan-results');
                
                resultsContainer.innerHTML = `
                    <div class="bg-white rounded-3xl p-10 shadow-lg text-center fade-in-up border border-gray-100">
                        <div class="mb-8">
                            <div class="relative w-20 h-20 mx-auto mb-6">
                                <div class="absolute inset-0 bg-green-gradient rounded-full animate-ping opacity-25"></div>
                                <div class="relative bg-green-gradient rounded-full w-20 h-20 flex items-center justify-center">
                                    <i class="fas fa-robot text-white text-2xl"></i>
                                </div>
                            </div>
                        </div>
                        <h3 class="text-3xl font-bold text-gray-800 mb-4">
                            AI Analyzing Your Device...
                        </h3>
                        <p class="text-gray-600 mb-6 text-lg">Our advanced AI is identifying your device and calculating its value</p>
                        <div class="max-w-md mx-auto">
                            <div class="bg-gray-200 rounded-full h-3 mb-2">
                                <div class="progress-bar h-3 rounded-full" style="width: 75%"></div>
                            </div>
                            <p class="text-sm text-gray-500">Processing image...</p>
                        </div>
                    </div>
                `;
                resultsContainer.classList.remove('hidden');
                
                console.log('‚è≥ Scanning progress shown');
            }

            displayScanResults(data) {
                const resultsContainer = document.getElementById('scan-results');
                const { analysis, environmentalImpact } = data;

                console.log('üìä Displaying scan results:', analysis);

                if (resultsContainer) {
                    resultsContainer.innerHTML = `
                        <div class="bg-white rounded-3xl p-10 shadow-lg fade-in-up border border-gray-100">
                            <div class="text-center mb-10">
                                <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
                                    <span class="text-4xl">${this.getDeviceEmoji(analysis.deviceType)}</span>
                                </div>
                                <h3 class="text-4xl font-bold text-gray-800 mb-4">Device Identified!</h3>
                                <div class="flex items-center justify-center space-x-4 mb-6">
                                    <span class="bg-green-100 text-green-800 px-6 py-3 rounded-full font-bold text-lg capitalize">${analysis.deviceType}</span>
                                    <span class="bg-blue-100 text-blue-800 px-6 py-3 rounded-full font-bold text-lg capitalize">${analysis.condition}</span>
                                </div>
                                <div class="text-gray-600 mb-8">
                                    <i class="fas fa-chart-line text-green-500 mr-2"></i>
                                    AI Confidence: <span class="font-semibold">${Math.round(analysis.confidence * 100)}%</span>
                                </div>
                            </div>

                            <!-- Reward Information -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
                                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-2xl p-8 text-center shadow-md">
                                    <i class="fas fa-coins text-4xl text-green-600 mb-4"></i>
                                    <div class="text-5xl font-bold text-green-600 mb-2">${analysis.coinsReward}</div>
                                    <p class="text-gray-600 font-semibold">Green Coins Reward</p>
                                </div>
                                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl p-8 text-center shadow-md">
                                    <i class="fas fa-dollar-sign text-4xl text-blue-600 mb-4"></i>
                                    <div class="text-5xl font-bold text-blue-600 mb-2">$${analysis.estimatedValue}</div>
                                    <p class="text-gray-600 font-semibold">Estimated Value</p>
                                </div>
                            </div>

                            <!-- Environmental Impact -->
                            <div class="bg-gradient-to-r from-green-50 via-blue-50 to-purple-50 rounded-2xl p-8 mb-10 shadow-md">
                                <h4 class="text-2xl font-bold text-gray-800 mb-6 text-center">
                                    <i class="fas fa-leaf text-green-500 mr-3"></i>
                                    Environmental Impact
                                </h4>
                                <div class="grid grid-cols-3 gap-6">
                                    <div class="bg-white rounded-xl p-6 text-center shadow-sm">
                                        <div class="text-3xl font-bold text-green-600 mb-2">${environmentalImpact.co2}kg</div>
                                        <div class="text-gray-600 font-medium">CO‚ÇÇ Saved</div>
                                    </div>
                                    <div class="bg-white rounded-xl p-6 text-center shadow-sm">
                                        <div class="text-3xl font-bold text-blue-600 mb-2">${environmentalImpact.energy}kWh</div>
                                        <div class="text-gray-600 font-medium">Energy Saved</div>
                                    </div>
                                    <div class="bg-white rounded-xl p-6 text-center shadow-sm">
                                        <div class="text-3xl font-bold text-purple-600 mb-2">${environmentalImpact.waste}kg</div>
                                        <div class="text-gray-600 font-medium">Waste Diverted</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex flex-col sm:flex-row gap-6">
                                <button onclick="window.deviceScanner.confirmRecycle()" class="flex-1 bg-green-gradient text-white py-5 px-10 rounded-2xl font-bold text-xl hover:shadow-lg transition-all transform hover:scale-105">
                                    <i class="fas fa-recycle mr-3"></i>
                                    Confirm & Recycle Now
                                </button>
                                <button onclick="window.deviceScanner.clearPreview()" class="flex-1 border-2 border-green-500 text-green-500 py-5 px-10 rounded-2xl font-bold text-xl hover:bg-green-gradient hover:text-white transition-all">
                                    <i class="fas fa-camera mr-3"></i>
                                    Scan Another Device
                                </button>
                            </div>
                        </div>
                    `;
                }
            }

            async confirmRecycle() {
                if (!this.checkAuth() || !this.currentScan) return;

                console.log('‚ôªÔ∏è Confirming recycle...');

                try {
                    const { analysis } = this.currentScan;
                    
                    const response = await fetch(`${this.API_BASE_URL}/devices/recycle`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            deviceType: analysis.deviceType,
                            condition: analysis.condition,
                            estimatedValue: analysis.estimatedValue,
                            coinsReward: analysis.coinsReward,
                            location: 'Web Scanner'
                        })
                    });

                    const data = await response.json();
                    console.log('‚úÖ Recycle response:', data);

                    if (response.ok) {
                        this.showRecycleSuccess(data);
                        this.updateNavCoins(data.user.coins);
                    } else {
                        this.showError(data.message || 'Failed to confirm recycling');
                    }

                } catch (error) {
                    console.error('‚ùå Recycle error:', error);
                    this.showError('Failed to confirm recycling. Please try again.');
                }
            }

            showRecycleSuccess(data) {
                const resultsContainer = document.getElementById('scan-results');
                const { transaction, user, newBadges } = data;

                if (resultsContainer) {
                    resultsContainer.innerHTML = `
                        <div class="bg-white rounded-3xl p-10 shadow-lg text-center fade-in-up border border-gray-100">
                            <div class="mb-10">
                                <div class="w-28 h-28 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
                                    <i class="fas fa-check text-5xl text-green-500"></i>
                                </div>
                                <h3 class="text-4xl font-bold text-gray-800 mb-6">
                                    üéâ Congratulations!
                                </h3>
                                <p class="text-green-600 font-bold text-3xl mb-4">You earned ${transaction.coinsEarned} Green Coins!</p>
                                <p class="text-gray-600 text-lg">Thank you for helping the environment! üå±</p>
                                ${newBadges && newBadges.length > 0 ? `
                                    <div class="mt-6 p-4 bg-yellow-50 rounded-xl border border-yellow-200">
                                        <p class="text-yellow-800 font-semibold mb-2">üèÜ New Badge${newBadges.length > 1 ? 's' : ''} Earned!</p>
                                        <div class="flex flex-wrap justify-center gap-2">
                                            ${newBadges.map(badge => `<span class="bg-yellow-200 text-yellow-800 px-3 py-1 rounded-full text-sm font-medium">${badge}</span>`).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>

                            <!-- Updated Stats -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-10">
                                <div class="bg-green-50 rounded-2xl p-6 shadow-sm">
                                    <div class="text-3xl font-bold text-green-600">${user.coins.toLocaleString()}</div>
                                    <div class="text-gray-600 font-medium">Total Coins</div>
                                </div>
                                <div class="bg-blue-50 rounded-2xl p-6 shadow-sm">
                                    <div class="text-3xl font-bold text-blue-600">${user.level}</div>
                                    <div class="text-gray-600 font-medium">Level</div>
                                </div>
                                <div class="bg-purple-50 rounded-2xl p-6 shadow-sm">
                                    <div class="text-3xl font-bold text-purple-600">${user.devicesRecycled}</div>
                                    <div class="text-gray-600 font-medium">Devices</div>
                                </div>
                                <div class="bg-orange-50 rounded-2xl p-6 shadow-sm">
                                    <div class="text-3xl font-bold text-orange-500">${user.badges.length}</div>
                                    <div class="text-gray-600 font-medium">Badges</div>
                                </div>
                            </div>

                            <div class="flex flex-col sm:flex-row gap-6">
                                <button onclick="window.deviceScanner.clearPreview()" class="flex-1 bg-green-gradient text-white py-5 px-10 rounded-2xl font-bold text-xl hover:shadow-lg">
                                    <i class="fas fa-camera mr-3"></i>
                                    Scan Another Device
                                </button>
                                <button onclick="window.location.href='rewards.html'" class="flex-1 border-2 border-green-500 text-green-500 py-5 px-10 rounded-2xl font-bold text-xl hover:bg-green-gradient hover:text-white">
                                    <i class="fas fa-gift mr-3"></i>
                                    View Rewards
                                </button>
                            </div>
                        </div>
                    `;
                }
            }

            getDeviceEmoji(deviceType) {
                const emojis = {
                    smartphone: 'üì±',
                    laptop: 'üíª',
                    tablet: 'üì±',
                    charger: 'üîå',
                    headphones: 'üéß',
                    smartwatch: '‚åö',
                    unknown: 'üì±'
                };
                return emojis[deviceType] || 'üì±';
            }

            showError(message) {
                console.error('‚ùå Scanner error:', message);
                
                const errorContainer = document.getElementById('error-message');
                const errorText = document.getElementById('error-text');
                
                if (errorContainer && errorText) {
                    errorText.textContent = message;
                    errorContainer.classList.remove('hidden');
                    
                    setTimeout(() => {
                        errorContainer.classList.add('hidden');
                    }, 8000);
                }
            }

            hideError() {
                const errorContainer = document.getElementById('error-message');
                if (errorContainer) {
                    errorContainer.classList.add('hidden');
                }
            }
        }

        // Initialize scanner when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ DOM loaded, initializing integrated scanner...');
            window.deviceScanner = new IntegratedDeviceScanner();
        });

        // Also initialize if DOM is already loaded
        if (document.readyState !== 'loading') {
            console.log('üöÄ DOM already loaded, initializing integrated scanner...');
            window.deviceScanner = new IntegratedDeviceScanner();
        }
    </script>
</body>
</html>